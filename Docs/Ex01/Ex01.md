---
title: 'Exercise 01: Provision resources to support the Lab'
layout: default
nav_order: 2
has_children: true
---


#TechExcel: Implementing automation practices using Azure OpenAI

![vmiegyu6.png](instructions232686/vmiegyu6.png)



# Exercise 01 - Install client tools
<!--- Estimated time: 60 minutes--->

To complete this lab, several tools must be available on your machine. In this exercise, you will determine which resources are already available and the versions for the resources. You will install tools or upgrade tools as necessary.

Estimated time to complete this exercise: *60 minutes*

#### **What you will learn**

After completing the tasks in this exercise, you will be able to:

- Identify Azure regions that support the resources that you need
- Install and run Visual Studio Code
- Determine the version of PowerShell present on a machine and upgrade PowerShell
- Determine the version of the PowerShell Az module present on a machine and install the module if necessary
- Determine the version of Azure CLI present on a machine and install Azure CLI if necessary
- Determine the version of the Azure CLI Bicep extension present on a machine and install the extension if necessary
- Determine the version of Git present on a machine and install Git if necessary
- Determine the version of Python present on a machine and install Python if necessary
- Determine the version of Docker Desktop present on a machine and install Docker Desktop if necessary



# Task 01 - Select a region for deploying Azure resources and create a resource group

<!--- Estimated time: 5 minutes--->

## Introduction

You will work with the GPT-4o and Text-Embedding-ADA-002 models in this lab. This limits the number of regions you can use for deployment.

## Description

In this task, you will select a region that has support for the services that the lab requires and you will create a resource group in that region.

The key steps are as follows:

1. Review reference articles that display information about which regions support Azure AI services and which AI models are available in each region.
1. Select a region to deploy Azure resources.
1. Create a resource group named *ContosoHotel* in the selected region.

## Success Criteria

- You have created a resource group in an Azure region that supports Azure AI services and the required AI models 

## Learning Resources

- [**Support for Azure AI Services**](https://azure.microsoft.com/en-us/explore/global-infrastructure/products-by-region/?products=cognitive-services)
- [**Region availability table for AI models**](https://learn.microsoft.com/azure/ai-services/openai/concepts/models#model-summary-table-and-region-availability)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

 Review the [support for Azure AI Services](https://azure.microsoft.com/en-us/explore/global-infrastructure/products-by-region/?products=cognitive-services) to identify regions where you can deploy Azure resources required by the lab. 

1.  Review the [region availability table](https://learn.microsoft.com/azure/ai-services/openai/concepts/models#model-summary-table-and-region-availability) to identify regions that support both GPT-4o and Text-Embedding-ADA-002 models. 

1.  Select an Azure region where you will deploy resources. 

1.  Open a browser window and go to the [Azure portal](https://portal.azure.com/). Sign in using your credentials.

1.  In the Search field on the Home page, enter and select **Resource groups**. 

1.  Select **Create**. 

1.  In the Resource group field, enter **ContosoHotel**. In the Region field, select the region where you will deploy resources.

1.  Select **Review + create** and then select **Create**.

</details>



# Task 02 - Install and update Visual Studio Code 

<!--- Estimated time: 5 minutes---> 

## Introduction

Visual Studio Code (VS Code) is a free, open-source code editor developed by Microsoft. It is highly popular among developers due to its versatility and extensive feature set. You will use Visual Studio Code throughout this lab to view and modify files and to run commands.

>{: .note }
It is important that you check for and install any updates for Visual Studio Code. Some of the extensions that you will use in this lab require the latest version of Visual Studio Code.

## Description

In this task, you will you will determine whether Visual Studio Code is installed on your machine and install the tool if necessary. You will also check to ensure that the latest version of Visual Studio Code is installed.

The key steps are as follows:

1. Identify whether Visual Studio Code is installed on your machine.
1. Check for updates and install updates if necessary.

## Success Criteria

- Visual Studio Code is installed and updated. 

## Learning Resources

- [**Introduction to Visual Studio Code**](https://learn.microsoft.com/en-us/training/modules/introduction-to-visual-studio-code/)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>
  
1.  On the Task Bar for your machine, search for **Visual Studio Code**.

1.  In the Search results, select **Visual Studio Code** to open the app. Then, on the menu bar, select **Help** and then select **Check for Updates**. Follow instructions to install any updates.

    >{: .important } If Visual Studio Code launches, skip the remaining steps in this task and move to the next task. Otherwise, complete the following steps to install Visual Studio Code.

1.  Open a web browser and go to [**Download Visual Studio Code**](https://code.visualstudio.com/Download). 

    ![eowd0o02.png](instructions232686/eowd0o02.png)

1.  Select **Windows**. The app installer should start downloading immediately.

    ![mhgbi9d9.png](instructions232686/mhgbi9d9.png)

1.  When the download completes, select **Open file**.

    ![94l4g99f.png](instructions232686/94l4g99f.png)

1.  On the Setup page, select **I accept the agreement** and then select **Next** twice. Select **Install**. Wait while the app installs.

    ![v0gny0yi.png](instructions232686/v0gny0yi.png)

1.  Select **Finish**. Wait while Visual Studio Code opens. 

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>



# Task 03 - Upgrade PowerShell

<!--- Estimated time: 5 minutes---> 

## Introduction

PowerShell is a powerful task automation and configuration management framework from Microsoft. It consists of a command-line shell, a scripting language, and a configuration management framework. To perform some steps in this lab you must use PowerShell version 7 or greater. 

## Description

In this task, you will determine which version of PowerShell is installed on your machine and upgrade PowerShell if necessary.

The key steps are as follows:

1. Check to see which version of PowerShell is installed.
1. Upgrade PowerShell to the latest version if necessary.
1. Verify the PowerShell version.

## Success Criteria

- You have installed PowerShell version 7 or greater. 

## Learning Resources

- [**What is PowerShell?**](https://learn.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.4)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  On the Visual Studio Code menu bar, select **Terminal** and then select **New Terminal**. A Terminal pane opens at the bottom of the window.

1.  Enter the following command at the Terminal window prompt. This command displays details about the PowerShell enviornment including the PowerShell version.

    ```
    $PSVersionTable
    ```

    ![x40l7rk9.png](instructions232686/x40l7rk9.png)

    >{: .important } If the value for PSVersion is at least 7, skip the remaining steps in this task and move on to the next task. Otherwise, complete the following steps to upgrade PowerShell.

1.  Open a web browser and go to [**Installing PowerShell on Windows**](
https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.4). 

1.  Scroll to the *Installing the MSI package* section and select the link for the 64-bit version of the installer. Wait for the installer package to download.

    ![r4aty1on.png](instructions232686/r4aty1on.png)

1.  When the download completes, select **Open file**.

    ![8zxs99u0.png](instructions232686/8zxs99u0.png)

1.  On the Setup page, select **Next** four times and then select **Install**.

1.  On the User Account Control page, select **Yes**.

1.  If the *Files in Use* page displays, select **OK**.

    ![eli44u6w.png](instructions232686/eli44u6w.png)    

1.  When the installation completes, select **Finish**.

1.  Enter the following command at the prompt in the Terminal window. Verify that PSVersion is at least 7.x.

    ```
    $PSVersionTable
    ```

    ![m336jt8z.png](instructions232686/m336jt8z.png)

    >{: .important } If you installed the latest version of PowerShell but the results from the $PSVersionTable command do not show the latest version, reboot your computer and run the command again.  

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>


# Task 04 - Install The PowerShell Az module 

<!--- Estimated time: 5 minutes---> 

## Introduction

The Az PowerShell module is a set of cmdlets for managing Azure resources directly from PowerShell. Itâ€™s the recommended module for interacting with Azure, replacing the older AzureRM module. You will use PowerShell Az module commands in this lab. 

## Description

In this task, you will install the Az PowerShell module.

The key steps are as follows:

1. Run a command to install the Az PowerShell module.
1. Verify that the module is correctly installed.

## Success Criteria

- You have successfully installed the AZ PowerShell module. 

## Learning Resources

- [**Introducing the Az PowerShll module**](https://learn.microsoft.com/en-us/powershell/azure/new-azureps-module-az?view=azps-12.3.0)
- [**Azure PowerShell Cheat Sheet**](https://github.com/andreipintica/Azure-PowerShell-CheatSheet)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Terminal window prompt. This command installs the PowerShell Az module. 

    ```
    Install-Module -Name Az -AllowClobber -Scope CurrentUser
    ```

    ![k466c8rr.png](instructions232686/k466c8rr.png)

1.  Select **A** to install the modules from PSGallery and then press the **Enter** key. Wait for the installation to complete.

    >{: .note } It may take 2-3 minutes for the installation to complete. The Terminal window may become temporarily unresponsive during installation.

1.  Enter the following command at the Terminal window prompt and then press the **Enter** key. This command verifies that the AZ module is properly installed.

    ```
    Get-InstalledModule -Name Az
    ```

    ![r8xcx9ri.png](instructions232686/r8xcx9ri.png)

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>



# Task 05 - Install Azure CLI 

You will use Azure CLI to run commands for this lab. .

<!--- Estimated time: 5 minutes---> 

## Introduction

The Azure Command-Line Interface (CLI) is a cross-platform command-line tool designed to manage Azure resources. You can use the Azure CLI to authenticate to Azure and to manage resources. 

## Description

In this task, you will ensure that Azure CLI is installed and install Azure CLI if needed.

The key steps are as follows:

1. Run a command to determine whether Azure CLI is installed.
1. Install Azure CLI if necessary.
1. Verify that the Azure CLI is correctly installed.

## Success Criteria

- You have successfully installed Azure CLI

## Learning Resources

- [**What is the Azure CLI?**](https://learn.microsoft.com/en-us/cli/azure/what-is-azure-cli)
- [**Azure CLI documentation**](https://learn.microsoft.com/en-us/cli/azure/)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Visual Studio Code Terminal window prompt and then press the **Enter** key. This command returns the Azure CLI version if Azure CLI is installed. 

    ```
    az --version
    ```

    ![4zap57az.png](instructions232686/4zap57az.png)

    >{: .important } If Azure CLI 2.53.1 or above is installed, skip the remaining steps in this task and move to the next task. Otherwise, complete the following steps to install Git.

1.  Open a web browser and go to [**Install Azure CLI on Windows**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli).

1.  In the Latest version section of the page, select **Latest MSI of the Azure CLI (64-bit)**. Wait while the MSI package downloads.

    ![owm7761z.png](instructions232686/owm7761z.png)

1.  When the download completes, select **Open file**.

    ![uvhtdr8i.jpg](instructions232686/uvhtdr8i.jpg)

1.  On the Setup dialog that displays, accept the license agreement and then select **Install**.

1.  On the User Account Control page, select **Yes**. Wait while Azure CLI installs.

1.  On the Setup dialog, select **Finish**.

1.  Return to Visual Studio Code. Enter the following command at Terminal window prompt and then press the **Enter** key. Verify that the command returns the Git version. 

    ```
    az --version
    ```

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>



# Task 06 - Install the Bicep extension for Azure CLI

<!--- Estimated time: 3 minutes---> 

## Introduction

Azure Bicep is a domain-specific language (DSL) designed for deploying Azure resources using a declarative syntax. It simplifies the process of creating Azure Resource Manager (ARM) templates, making it easier to define and manage your infrastructure as code. You will use Bicep commands in this lab.

## Description

In this task, you will ensure that the Bicep extension for Azure CLI is installed and install the Bicep extension if needed. You will also add Bicep to the system environment path.

The key steps are as follows:

1. Run a command to determine whether Azure Bicep is installed.
1. Install Azure Bicep if necessary.
1. Verify that the Azure Bicep is correctly installed.

## Success Criteria

- You have successfully installed Azure Bicep

## Learning Resources

- [**What is Bicep?**](https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/overview?tabs=bicep)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Visual Studio Code Terminal window prompt and then press the **Enter** key. This command returns Bicep version if Bicep is installed. 

    ```
    bicep --version
    ```

    ![7zo8vjkr.png](instructions232686/7zo8vjkr.png)

    >{: .important } If the Bicep extension is installed, skip the remaining steps in this task and move to the next task. Otherwise, complete the following steps to install the extension.

1.  Enter the following commands at the Visual Studio Code Terminal window prompt and then press the **Enter** key. These commands install Bicep and adds Bicep to the environment path.

    ```
    $installPath = "$env:USERPROFILE\.bicep"
    $installDir = New-Item -ItemType Directory -Path $installPath -Force
    $installDir.Attributes += 'Hidden'
    (New-Object Net.WebClient).DownloadFile("https://github.com/Azure/bicep/releases/latest/download/bicep-win-x64.exe", "$installPath\bicep.exe")
    $currentPath = (Get-Item -path "HKCU:\Environment" ).GetValue('Path', '', 'DoNotExpandEnvironmentNames')
    if (-not $currentPath.Contains("%USERPROFILE%\.bicep")) { setx PATH ($currentPath + ";%USERPROFILE%\.bicep") }
    if (-not $env:path.Contains($installPath)) { $env:path += ";$installPath" }
    ```

1.  Return to Visual Studio Code. Enter the following command at the Terminal window prompt and then press the **Enter** key. Verify that the command returns the Git version. 

    ```
    bicep --version
    ```

    ![q2p2usqa.png](instructions232686/q2p2usqa.png)

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>



# Task 07 - Install Git 


<!--- Estimated time: 5 minutes---> 

## Introduction

Git is a distributed version control system designed to track changes in source code during software development. GitHub is a web-based platform that uses Git, the popular version control system, to help developers manage and collaborate on code projects. You will use Git commands to clone GitHub repositories for this lab and perform other related actions.

## Description

In this task, you will ensure that Git is installed and install Git if needed. 

The key steps are as follows:

1. Run a command to determine whether Git is installed.
1. Install Git if necessary.
1. Verify that the Git is correctly installed.

## Success Criteria

- You have successfully installed Git

## Learning Resources

- [**What is Git?**](https://learn.microsoft.com/en-us/devops/develop/git/what-is-git)
- [**Introduction to GitHub**](https://learn.microsoft.com/en-us/training/modules/introduction-to-github/)
- [**Collaborate with Git**](https://learn.microsoft.com/en-us/training/modules/collaborate-with-git/")

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Visual Studio Code Terminal window prompt and then press the **Enter** key. This command returns the Git version if Git is installed. 

    ```
    git --version
    ```

    ![gockp6up.png](instructions232686/gockp6up.png)

    >{: .important } If Git is installed, skip the remaining steps in this task and move to the next task. Otherwise, complete the following steps to install Git.

1.  Open a web browser and go to [**Git Downloads**](https://git-scm.com/download/). Select **Download for Windows**.

    ![48ji0470.png](instructions232686/48ji0470.png)

1.  On the Download for Windows page, select **Click here to download**. The  installer should start downloading immediately.

    ![pu37zyg6.png](instructions232686/pu37zyg6.png)

1.  When the download completes, select **Open file**.

    ![2w3ijvzl.png](instructions232686/2w3ijvzl.png)

1.  If a User Account Control dialog displays, select **Yes**.

    ![34e9oeua.png](instructions232686/34e9oeua.png)

1. On the Git Setup dialog, select **Install**. Wait while Git installs.

    ![mfjucmw6.png](instructions232686/mfjucmw6.png)

1.  On the Git Setup dialog, select **Finish**.

    ![xh6259zj.png](instructions232686/xh6259zj.png)

1.  Return to Visual Studio Code. Enter the following command at the Terminal window prompt and then press the **Enter** key. Verify that the command returns the Git version. 

    ```
    git --version
    ```

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>


# Task 08 - Install Python 

<!--- Estimated time: 5 minutes---> 

## Introduction

Python is a versatile, high-level programming language known for its readability and ease of use. It supports multiple programming paradigms, including procedural, object-oriented, and functional programming. Python is widely used in various fields such as web development, data science, artificial intelligence, automation, and more. The legacy Contoso Hotel app that you will deploy uses Python code. 

## Description

In this task, you will ensure that Python is installed and install Python if needed.

The key steps are as follows:

1. Run a command to determine whether Python is installed.
1. Install Python if necessary.
1. Verify that the Python is correctly installed.

## Success Criteria

- You have successfully installed Python

## Learning Resources

- [**Introduction to Python?**](https://learn.microsoft.com/en-us/training/modules/intro-to-python/)
- [**Create and manage projects in Python**](https://learn.microsoft.com/en-us/training/modules/python-create-manage-projects/)
- [**Collaborate with Git**](https://learn.microsoft.com/en-us/training/modules/collaborate-with-git/")

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Visual Studio Terminal window prompt and then press the **Enter** key. This command returns the Python version if Python is installed. 

    ```
    python --version
    ```

    ![nvp4l2p8.png](instructions232686/nvp4l2p8.png)

    >{: .important } If Python is installed, skip the remaining steps in this task and move on to the next task. Otherwise, complete the following steps to install Python.

1.  Open a web browser and go to [**Download the latest version of Python**](https://www.python.org/downloads/). 

    ![m7y9ictq.png](instructions232686/m7y9ictq.png)

1.  On the Download the latest version for Windows page, select **Download Python**. The  installer should start downloading immediately.

1.  When the download completes, select **Open file**.

    ![xscx7ua3.png](instructions232686/xscx7ua3.png)

1. On the Python Setup dialog, select **Install Now**. 

    ![gaojc236.png](instructions232686/gaojc236.png)

1.  If a User Account Control dialog displays, select **Yes**. Wait while Python installs.

    ![ni2snffz.png](instructions232686/ni2snffz.png)

1.  On the Python Setup dialog, select **Close**.

    ![792sy8vq.png](instructions232686/792sy8vq.png)

1.  Return to Visual Studio Code. Enter the following command at the Terminal window prompt and then press the **Enter** key. Verify that the command returns the Python version. 

    ```
    python --version
    ```

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>



# Task 09 - Install the Prompt flow for VS Code extension

<!--- Estimated time: 5 minutes---> 

## Introduction

Later in this lab you will use the Promptflow tool in Azure AI Studio to create a chatbot. Visitors to the Contoso Hotels website will use the chatbot to ask questions and find their ideal hotel.

Visual Studio Code provides a PromptFlow extension to help streamline the development of AI applications. 

## Description

In this task, you will install the Prompt flow extension for Visual Studio Code. To install this extension, Visual Studio Code must be updated to the latest version and Python must be installed on your computer.

The key steps are as follows:

1. Open the Extensions pane in Visual Studio.
1. Search for and install the Prompt flow for VS Code extension.

## Success Criteria

- You have successfully installed the Prompt flow for VS Code extension. 

## Learning Resources

- [**Pip Install**](https://python.land/virtual-environments/installing-packages-with-pip)
- [**Prompt flow for VS Code**](https://marketplace.visualstudio.com/items?itemName=prompt-flow.prompt-flow)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  In Visual Studio Code, press the **Ctrl** **Shift** **X** key combination to open the Visual Studio Code Extensions pane.

1.  In the Extensions pane Search field, enter **Prompt flow**.

1.  In the search results, select **Prompt flow for VS Code** and then select **Install**. Wait while the extension installs.

    >{: .important } You may see an error stating that the extension is not compatbile with the version of Visual Studio Code that you have installed. If you see the error, follow the steps in Exercise 01 Task 02 to upgrade Visual Studio Code.

1.  Enter the following command at the Visual Studio Code Terminal prompt. This command installs libraries that support Promptflow.

    ```
    pip install promptflow promptflow-tools promptflow-azure
    pip install --upgrade promptflow-tools
    ```

1.  Leave Visual Studio Code open. You will use the tool again in the next task.

</details>



# Task 10 -Install Docker Desktop

<!--- Estimated time: 7 minutes---> 

## Introduction

Docker is an open-source platform designed to automate the deployment, scaling, and management of applications using containerization. Containers are lightweight, standalone, and executable packages that include everything needed to run a piece of software, such as the code, runtime, system tools, libraries, and settings. As part of the lab you will deploy app components to Docker containers. 

## Description

In this task, you will ensure that Docker Desktop is installed and install Docker Desktop if needed.

The key steps are as follows:

1. Run a command to determine whether Docker is installed.
1. Install Docker if necessary.
1. Verify that Docker is correctly installed.

## Success Criteria

- You have successfully installed Docker Desktop 

## Learning Resources

- [**What is Docker**](https://learn.microsoft.com/en-us/dotnet/architecture/microservices/container-docker-introduction/docker-defined)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Visual Studio Code Terminal window prompt. This command returns the Docker version if Docker is installed. 

    ```
    docker --version
    ```

    ![ixcuytf8.png](instructions232686/ixcuytf8.png)

    >{: .important } If Docker is installed, skip the remaining steps in this task and move to the next exercise. Otherwise, complete the following steps to install Docker.

1.  Open a web browser and go to  [**Install Docker Desktop on Windows**](https://docs.docker.com/desktop/install/windows-install). 

    ![40vk57jr.png](instructions232686/40vk57jr.png)

1.  Select **Docker Desktop for Windows - x86_64**. The  installer should start downloading immediately.

1.  When the download completes, select **Open file**.

1.  If a User Account Control dialog displays, select **Yes**.

1.  Follow the prompts to install Docker Desktop. 

    >{: .note } You may need to restart your machine as part of the Docker Desktop installation process.

1.  On the Python Setup dialog, select **Close**.
    
1.  Return to Visual Studio Code. Enter the following command at the Terminal window prompt and then press the **Enter** key. Verify that the command returns the Docker version. 

    ```
    docker --version
    ```

1.  Leave Visual Studio Code open. You will use the tool in the next exercise.

</details>



# Exercise 02 - Deploy and review the legacy Contoso Hotel app

## Lab Scenario

The legacy Contoso Hotel app was written by using Python code. App components run inside a Docker container. The app can connect to a SQL Server or PostgreSQL database (on-premises or online). 

In this exercise, you will deploy the legacy app to a Docker container and then run the container. You will provision a PostgreSQL database instance on Azure. You will setup and review the app, and then test the app by adding a new booking.

## Objectives

After you complete this lab, you will be able to:

- Clone a GitHub repository to your local machine
- Build a Docker container for app components
- Create an Azure Container Registry (ACR) instance to store Docker containers
- Push the Docker container for the app to ACR
- Provision a PostgreSQL database in Azure to support the app
- Run the containerized app and populate the database
- Review the legacy Contoso Hotel app and add a booking

## Exercise Duration

Estimated time to complete this exercise: *45 minutes*



# Task 01 - Clone the GitHub repository for the project to your local machine

<!--- Estimated time: 3 minutes---> 

## Introduction

The Contoso Hotel app is monolithic. Front-end components (HTML, CSS, and JavaScript files) and back-end components (APIs) are all deployed as a single unit. The files required to deploy the legacy app are stored in a GitHub repository. 

## Description

In this task, you will clone the GitHub repository to the Downloads folder on your local machine. 

The key steps are as follows:

1. Clone the GitHub repository for the project to the Downloads\ContosoHotel folder.
2. Verify that the files are present on your local machine.

## Success Criteria

- The files for the legacy app are available in the Downloads\ContosoHotel folder on your machine

## Learning Resources

- [**Collaborate with Git**](https://learn.microsoft.com/en-us/training/modules/collaborate-with-git/ "Collaborate with Git.")

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.   Open File Explorer on your computer and go to the Downloads folder. 

    ![otderjk6.png](instructions232686/otderjk6.png)

1.  Input the following into the Visual Studio Code Terminal and press **Enter** to set your Downloads folder path as a variable.

    ```
    $PATH_TO_DOWNLOADS_FOLDER = "C:\Users\Admin\Downloads"
    ```

1.  Enter the command at the Visual Studio Code Terminal window prompt and then press the **Enter** key to clone the GitHub repository to the Downloads\ContosoHotel folder on your computer. 

    ```
    git clone https://github.com/qxsch/ContosoHotel "$PATH_TO_DOWNLOADS_FOLDER\ContosoHotel"
    ```

    ![dp4fs8k5.png](instructions232686/dp4fs8k5.png)

1.  Open File Explorer and go to your Downloads folder. Verify that the ContosoHotel folder and files are present.

    ![avo8pw2u.png](instructions232686/avo8pw2u.png)

1.  Leave Visual Studio Code open. You will use the tool in the next task.

</details>



#Task 02: Build a Docker container for the app

<!--- Estimated time: 7 minutes---> 

## Introduction

You will run the legacy Contoso Hotel app in a Docker container. Docker is an open-source platform that automates the deployment, scaling, and management of applications. It uses containerization technology to package an application and its dependencies into a container, ensuring that it runs consistently across different environments.

## Description

In this task you create the Docker container and add app components to the container.

The key steps are as follows:

1. Launch Docker Desktop 
1. Verify that the Docker engine is running
1. Build a Docker container for the app

## Success Criteria

- The Docker engine is running
- You have built a Docker container for the app

## Learning Resources

- [**Introduction to Docker containers**](https://learn.microsoft.com/en-us/training/modules/intro-to-docker-containers/ )
- [**Build a containerized web application with Docker**](https://learn.microsoft.com/en-us/training/modules/intro-to-containers/)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Open **Docker Desktop**. Wait for the app to start. After the app starts wait for the app to start Docker Engine.

    ![x2zpfcur.png](instructions232686/x2zpfcur.png)

1.  Minimize Docker Desktop but do not close the app.

1.  Enter the following command at the Visual Studio Terminal window prompt and press the **Enter** key. This command allows you to run commands as an administrator.

    ```
    Start-Process powershell -Verb runAs
    ```

1.  In the User Account Control window that displays, select **Yes**. A PowerShell window opens.

    ![hj3c4ve2.png](instructions232686/hj3c4ve2.png)

1.  Enter the following command at the PowerShell prompt and then press the **Enter** key. This command configures the Docker daemon to start automatically.

    ```
    Set-Service -Name com.docker.service -StartupType Automatic
    ```

    >{: .important } The Set-Service command will fail if you are not running PowerShell as an administrator.

1.  Enter the following command at the PowerShell prompt and then press the **Enter** key. This command manually starts the Docker daemon.

    ```
    Start-Service -Name com.docker.service
    ```

    ![ld27t68z.png](instructions232686/ld27t68z.png)

1.  Enter the following command at the PowerShell prompt and then press the **Enter** key. This command checks the status of the Docker daemon. Verify that the results show the Docker daeomon is running.

    ```
    Get-Service -Name com.docker.service
    ```

    ![2w42g4so.png](instructions232686/2w42g4so.png)

1.  Minimize the PowerShell window. Return to Visual Studio Code.

1.  Modify the file path, if needed, for the following command to point to Downloads\ContosoHotel folder that you created. Enter the command at the Visual Studio Code Terminal window and then press the **Enter** key. This command switches the context to the folder where the cloned repository resides.

    ```
    cd $PATH_TO_DOWNLOADS_FOLDER\ContosoHotel
    ```

    ![m6q69ffk.png](instructions232686/m6q69ffk.png)

1.  Enter the following command at the Terminal window prompt and then press the **Enter** key. This command builds the container for the app. Wait while the container builds.

    ```
    docker build -t "pycontosohotel:v1.0.0" .
    ```

    ![yhdwim2f.png](instructions232686/yhdwim2f.png)

    >{: .note }It may take 2-3 minutes to build the container.

1.  Leave Visual Studio Code open. You will use the tool in the next task.

</details>



# Task 03: Create an Azure Container Registry (ACR) instance and push the app container to ACR

<!--- Estimated time: 10 minutes---> 

## Introduction

Azure Container Registry (ACR) is a managed, private Docker registry service provided by Microsoft Azure. It allows you to store and manage container s and artifacts in a secure and scalable manner. 

## Description

In this task, you will create an Azure Container Registry instance.

The key steps are as follows:

1. Create an Azure Container Registry instance. 
1. Sign in to ACR and push the app container that you created in the previous task to ACR.

## Success Criteria

- You have pushed the app container to ACR. 

## Learning Resources

- [**Manage container s in Azure Container Registry**](https://learn.microsoft.com/en-us/training/modules/publish-container--to-azure-container-registry/)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following command at the Visual Studio Code Terminal window prompt and then press the **Enter** key. The Terminal window will display a device code. 

    ```
    Connect-AzAccount  -DeviceCode
    ```

1.  **Ctrl+Click** the link to navigate to [**Device Login**](https://microsoft.com/devicelogin/) in your browser. Enter the **device code** and follow the instructions to sign in.

    ![itz8mvhb.jpg](instructions232686/itz8mvhb.jpg)

1.  Enter the device code and then select **Next**. Select your account and then select **Next**.

1.  On the *Are you trying to sign in to Microsoft Azure PowerShell page*, select **Continue**.

    ![zh6yjld6.png](instructions232686/zh6yjld6.png)

1.  Close the web page and return to Visual Studio Code. 

1.  If prompted, select the subscription you wish to use. You should use the same subscription where you created the resource group in Exercise 01 Task 01.

1.  Enter the following command at the Terminal Window prompt and then press the **Enter** key. This command generates a unique name for the ACR instance.

    ```
    $ACR_NAME = "contosoacr$(Get-Random -Minimum 100000 -Maximum 999999)"
    Write-Host -ForegroundColor Green  "ACR name is: " $ACR_NAME
    ```

    >{: .note } Record the ACR name. You will need to supply the ACR name again in a future Exercise.

1.  Enter the following command at the Terminal Window prompt and then press the **Enter** key.

    ```
    az login
    ```

    ![x8ary55x.jpg](instructions232686/x8ary55x.jpg)

1.  Enter the following command at the Terminal Window prompt and then press the **Enter** key. This command creates an ACR instance.

    ```
    az acr create --resource-group "ContosoHotel" --name "$ACR_NAME" --sku Basic --admin-enabled true
    ```

    ![lgtrgnlb.png](instructions232686/lgtrgnlb.png)


1.  Enter the following command at the Terminal Window prompt and then press the **Enter** key. This command signs you in to the ACR instance.

    ```
    az acr login --name "$ACR_NAME"
    ```

    ![266ttbar.png](instructions232686/266ttbar.png)

    >{: .important } You may see an error message stating the Azure could not connect to the registry login server. This error usually indicates that even though the container registry instance is provisioned there is still some configuration happening. Wait a few minutes and run the command again.

1.  Enter the following command at the Terminal Window prompt and then press the **Enter** key. This command creates a Docker tag for the app.

    ```
    docker tag "pycontosohotel:v1.0.0" "$ACR_NAME.azurecr.io/pycontosohotel:v1.0.0"
    ```

1.  Enter the following command at the Terminal Window prompt and then press the **Enter** key. This command pushes the app container to ACR.

    ```
    docker push "$ACR_NAME.azurecr.io/pycontosohotel:v1.0.0"
    ```

    ![6kejtvu5.png](instructions232686/6kejtvu5.png)

    >{: .note } It may take 1-2 minutes to push the app container to ACR.

1.  Leave Visual Studio Code open. You will use the tool in the next task.



# Task 04: Provision a PostgreSQL database to support the app

<!--- Estimated time: 10 minutes---> 

## Introduction

The Contoso Hotel legacy app stores data in a PostgreSQL database. PostgreSQL is a powerful, open-source relational database management system (RDBMS). It is known for its robustness, extensibility, and standards compliance. Azure Database for PostgreSQL Flexible Server is a fully managed database service designed to provide more granular control and flexibility over database management functions and configuration settings. 

 The database uses the following schema:

![ContosoHotelsERD.png](instructions232686/ContosoHotelsERD.png)

## Description

In this task, you will provision a Azure Database for PostgreSQL flexible server instance. 

The key steps are as follows:

1. Run the  Connect-AzAccount cmdlet to connect Visual Studio Code to Azure with an authenticated account. 
1. Run the `manageIac.ps1` script from the `ContosoHotel\iac` folder to deploy an Azure Database for PostgreSQL Flexible Server instance. 

## Success Criteria

- You have provisioned an Azure Database for PostgreSQL Flexible Server instance. 

## Learning Resources

- [**Connect-AzAccount**](https://learn.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount?view=azps-12.3.0)
- [**Explore PostgreSQL architecture**](https://learn.microsoft.com/en-us/training/modules/explore-postgresql-architecture/ )

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

 In this task, you will provision a PostgreSQL database in Azure to support the app.

1.  Replace the text *<ReplaceWithTheAzureRegionYouSelected>* in the following command with the Azure region location that you selected earlier in the lab. Enter the command at the Terminal window prompt and then press the **Enter** key. This command deploys a PostgreSQL server instance. 

    ```
    .\iac\manageIac.ps1 -iacAction create -passwd "myLittleSecret111!!!" -deploy "postgresql" -rgname "ContosoHotel" -location "<ReplaceWithTheAzureRegionYouSelected>"
    ```

    >{: .note } The script first checks for common errors and then provisions the database. </br></br>It may take 6-10 minutes to deploy the PostgreSQL server instance. You may see several warnings display during deployment. 

    >{: .important } You may see an error stating that Bicep is not find. If this error displays, repeat the steps in Exercise 01 Task 06 and then run the command again.

1.  When the deployment completes, the Terminal window will display a message in green font that shows the connection string for the database. 

       ![7stqwpr8.png](instructions232686/7stqwpr8.png)

1.  The connection string should resemble the following string. Record the connection string for use later in the lab: </br></br>host=53pkyjrx5j7ve.postgres.database.azure.com;
    port=5432;database=pycontosohotel;user=contosoadmin;password=@lab.CloudPortalCredential(Admin).Password; 
   
1.  Leave Visual Studio Code open. You will use the tool in the next task.

</details>



# Task 05: Run the containerized app and add a booking

<!--- Estimated time: 5 minutes---> 

## Introduction
You created a Docker container and pushed the container to ACR in previous tasks. Now, you will run the container and view the app in a browser. Since this is the first time you are running the app, you will need to run a process to create the database schema and populate the tables with data.

Now, you can view the various pages for the app and try out the features.
 

## Description

In this task, you will run the Docker app container and then display the setup page for the app. You will  create the database schema and populate the tables with data. You will review common app pages and add a booking record. Finally, you will search for the record you just added to verify that the record was successfully added to the database.

The key steps are as follows:

1. Run the Docker container on port 8000.
1. Open the app at http://localhost:8000/setup.
1. Run the setup process in the app to add records to the database.
1. Review the app pages.
1. Add the following booking record:

    | Field | Value |
    |:---------|:---------|
    | Hotel   | **Contoso Suites Athens**  |
    | Visitor   | **Emma Davis**|
    | Check-in   | **12/28/2024**|
    | Check-out   | **01/05/2025**|
    | Adults   | **2**|
    | Rooms   | **1**|

1. Verify that the new record is saved and close the browser window.

## Success Criteria

- You can view the app in a web browser.
- You can add a booking record to the app and verify that the record is saved and is searchable.

## Learning Resources

[**Manage container s in Azure Container Registry.**](
https://learn.microsoft.com/en-us/training/modules/publish-container--to-azure-container-registry/ "Manage container s in Azure Container Registry")

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Replace the *EnterConnectionStringForDatabase* placeholder text in the following command with the connection string you recorded in the previous task. Enter the command at the Visual Studio Code Terminal window prompt and then press the **Enter** key. This command starts the containerized app.

    ```
    docker run -p 8000:8000 -e POSTGRES_CONNECTION_STRING="EnterConnectionStringForDatabase" pycontosohotel:v1.0.0
    ```
    
    ![gjlnvrtf.jpg](instructions232686/gjlnvrtf.jpg)
    
    >{: .important } Do not close the Visual Studio Code Terminal window at this time.

1.  Open a web browser and go to **http://localhost:8000/setup**. The Contoso Hotel Setup page displays.

    ![1ri1l25o.png](instructions232686/1ri1l25o.png)

1.  On the Contoso Hotel Setup page, select **Setup database**. This launches a script that creates the database schema and populates the tables with data.

    >{: .note } The page updates when the script completes.

    ![yfke4jk3.png](instructions232686/yfke4jk3.png) 

1.  On the Contoso Hotel Setup page, select **Home**. The home page for the app displays.

1.  On the Home page, select the calendar icon to go to the Bookings page.

    ![bzl5gq1d.png](instructions232686/bzl5gq1d.png)

1.  On the Bookings page, select **New Booking**.

    ![cbrvrolp.png](instructions232686/cbrvrolp.png)

1.  Enter the following information into the page and then select **Add Booking**. The page will update to show you that the booking is successfully created.

    | Field | Value |
    |:---------|:---------|
    | Hotel   | **Contoso Suites Athens**   |
    | Visitor   | **Emma Davis**|
    | Check-in   | **12/28/2024**|
    | Check-out   | **01/05/2025**|
    | Adults   | **2**|
    | Rooms   | **1**|

    >{: .important }The Visitor field doesn't search properly. Type in the letter 'a' into the field and select a name from the dropdown.

    ![izps11yx.jpg](instructions232686/izps11yx.jpg)

    ![1i44bvk4.png](instructions232686/1i44bvk4.png)

1.  On the Bookings page, select **List Bookings**.

1.  Enter **Emma Davis**, or whichever Visitor you selected, in the Search field. The booking that you created should appear in the list of bookings.

    ![7b7dy1c7.png](instructions232686/7b7dy1c7.png)

1.  Close the browser window.

1.  In Visual Studio Code, press the **Ctrl+C** keyboard combination from the Terminal pane to exit the running worker processes.

1.  Leave Visual Studio Code open. You will use the toool again in the next exercise.

</details>



# Exercise 03 - Split and repackage the Contoso Hotel app components and deploy the updated app

To improve the scalability of the app, Contoso plans to split the front-end components (HTML, CSS, and JavaScript files) from back-end components (APIs). In this exercise you will split the components and refactor some code. Then, you will deploy the frontend and backend components to separate containers. Finally, you will push the containers to ACR and run the updated app. 

The updated app will use the following architecture:

![bax0ke9c.png](instructions232686/bax0ke9c.png)

## Objectives

After completing the tasks in this exercise, you will be able to:

- Separate front-end components from back-end components
- Refactor the front-end views.py file
- Refactor other front-end files
- Refactor the back-end views.py file
- Build the containers for front-end and back-end components
- Create the container apps in Azure
- Configure CORS in the backend source code

## Exercise Duration

Estimated time to complete this exercise: *60 minutes*



# Task 01 - Separate front-end components from back-end components

<!--- Estimated time: 15 minutes---> 

## Introduction

The Contoso Hotel legacy app is monolithic. That is, front-end components and back-end components are deployed as a single unit. Mololithic apps do not scale very well. Contoso wants to ensure that the app scales to meet expected increases in demand.

Microsoft AppCAT (Application and Code Assessment Tool) is part of the Azure Migrate suite. The AppCAT tool assesses applications and code and identifies depenencies and linkages. At this time, AppCAT only supports .NET and Java apps. Python is not supported.

## Description

In this task, you will manually separate frontend and backend components into separate folders.

The key steps are as follows:

1. Create a folder named UpdatedApp with subfolders FrontEnd and Backend.
1. Copy all front-end files to the FrontEnd folder and all back-end files to the Backend folder.

## Success Criteria

- You have created the UpdatedApp folder and the FrontEnd and Backend subfolders. 
- You have copied the required files to the FrontEnd and Backend subfolders.
- 

## Learning Resources

- [**Decompose a monolithic application**](https://learn.microsoft.com/en-us/training/modules/microservices-architecture/ )
- [**Azure Migrate application and code assessment**](https://learn.microsoft.com/en-us/azure/migrate/appcat/overview )

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Open Visual Studio Code.

1.  On the Visual Studio Code menu bar, select **Terminal** and then select **New Terminal**. A Terminal pane opens at the bottom of the window.

    ![gzt09m0m.png](instructions232686/gzt09m0m.png)

1.  Update the value for the $PATH_TO_DOWNLOADS variable to point to the Downloads folder on your machine. Enter the following commands at the Terminal window prompt to set the variable and change directories to that folder, which contains the repository files you cloned in Exercise 01.

    ```
    $PATH_TO_DOWNLOADS = "C:\Users\Admin\Downloads"
    cd $PATH_TO_DOWNLOADS
    ```

    ![vtuuzcop.png](instructions232686/vtuuzcop.png)

1.  Enter the following command at the Terminal window prompt. This command creates a directory for front-end components.

    ```
    mkdir -p UpdatedApp/Frontend
    ```

    ![4wut3qpe.png](instructions232686/4wut3qpe.png)

1.  Enter the following command at the Terminal window prompt. This command creates a directory for back-end components.

    ```
    mkdir -p UpdatedApp/Backend 
    ```

    ![r9w825ez.png](instructions232686/r9w825ez.png)

1.  Open File Explorer and go to the Downloads\ContosoHotel folder. Verify that the folders you created are present.

    ![0pd5q1t7.png](instructions232686/0pd5q1t7.png)

1.  Enter the following commands at the Terminal window prompt. These commands copy all necessary files to the **Frontend** folder for the updated app.

    ```
    cd $PATH_TO_DOWNLOADS\ContosoHotel
    cp startup.* $PATH_TO_DOWNLOADS\UpdatedApp\Frontend
    cp uwsgi.ini $PATH_TO_DOWNLOADS\UpdatedApp\Frontend
    cp Dockerfile $PATH_TO_DOWNLOADS\UpdatedApp\Frontend
    cp *.docker* $PATH_TO_DOWNLOADS\UpdatedApp\Frontend
    cp requirements.txt $PATH_TO_DOWNLOADS\UpdatedApp\Frontend
    ```
    ![rc0em1zh.png](instructions232686/rc0em1zh.png)

1.  Enter the following commands at the Terminal window prompt. These commands create a subfolder in the **Frontend** folder and copy all necessary files to subfolder.

    ```
    cd $PATH_TO_DOWNLOADS

    cp -r ContosoHotel/contoso_hotel/static $PATH_TO_DOWNLOADS\UpdatedApp\Frontend\contoso_hotel\
    cp -r ContosoHotel/contoso_hotel/templates $PATH_TO_DOWNLOADSs\UpdatedApp\Frontend\contoso_hotel\
    cp ContosoHotel/contoso_hotel/*.py $PATH_TO_DOWNLOADS\UpdatedApp\Frontend\contoso_hotel\
    ```

    ![4hvmj7az.png](instructions232686/4hvmj7az.png)
1.  Enter the following commands at the Terminal window prompt. These commands copy all necessary files to the **Backend** folder for the updated app.

    ```
    cd $PATH_TO_DOWNLOADS\ContosoHotel
    cp *.sql $PATH_TO_DOWNLOADS\UpdatedApp\Backend
    cp startup.* $PATH_TO_DOWNLOADS\UpdatedApp\Backend
    cp uwsgi.ini $PATH_TO_DOWNLOADS\UpdatedApp\Backend
    cp *docker* $PATH_TO_DOWNLOADS\UpdatedApp\Backend
    cp requirements.txt $PATH_TO_DOWNLOADS\UpdatedApp\Backend
    ```

    ![cy6qnctf.png](instructions232686/cy6qnctf.png)

1.  Enter the following commands at the Terminal window prompt. These commands create a subfolder in the **Backend** folder and copy all necessary files to subfolder.

    ```
    cd $PATH_TO_DOWNLOADS\

    cp -r ContosoHotel/contoso_hotel/dblayer $PATH_TO_DOWNLOADS\UpdatedApp\Backend\contoso_hotel\
    cp ContosoHotel/contoso_hotel/*.py $PATH_TO_DOWNLOADS\UpdatedApp\Backend\contoso_hotel\
    ```

    ![4lx92yj1.png](instructions232686/4lx92yj1.png)

1.  Leave Visual Studio Code open. You will use the toool again in the next exercise.

</details>


# Task 02 - Refactor  files

<!--- Estimated time: 15 minutes---> 

## Introduction

The *views.py* file defines app routes, endopoints, and views. The file is divided into the following sections:

- Import statements
- Back-end API endpoints
- Front-end API endpoints

The *Dockerfile* file defines the Docker  to use and provides instructions for copying app components to the Docker container when you build the container. 

The *requirements.txt* file specifies the packages that the app requires to run. 

## Description

In the previous task, you added a copy of views.py to both the Fronted and Backend folders. You added the Dockerfile file and the requirements.txt file to the FrontEnd folder. In this task, you will modify all three files to remove references to back-end functionality. You will also modify the copy of views.py in the Backend folder to remove references to front-end functionality.

The key steps are as follows:

1. Open views.py from the FrontEnd folder in Visual Studio Code and remove the Backend API endpoints section.
1. Remove the dblayer reference from the views.py Imports section.
1. Remove the code from views.py that checks to see if the database is set up.
1. Update Dockerfile to remove the code that installs the MSSQL ODBC driver.
1. Update requirements.txt to remove references to the pyodbc and psycopg2-binary libraries.
1. Open views.py from the BacktEnd folder in Visual Studio Code and remove the Frontend API endpoints section.

## Success Criteria

- You have updated views.py, Dockerfile, and requirements.txt files in the FrontEnd folder and removed back-end code and references to data libraries. 
- You have updated views.py in the BackEnd folder and removed front-end code.

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

In this task, you will refactor the front-end *views.py* file in the UpdatedApp\FrontEnd folder.


1.  In Visual Studio Code, press the **Ctrl** **Shift** **E** key combination to open the Explorer pane.

1.  In the Explorer pane, select **Open Folder**.

1.  In the Open Folder dialog, select the **Downloads** folder, select **UpdatedApp**, and the select **Select Folder**.

1.  In the *Do you trust the authors of the files in this folder?* dialog, select **Trust the authors of all files in the parent folder 'Downloads'** and then select **Yes, I trust the authors**. 

    ![yq54qnra.png](instructions232686/yq54qnra.png)

1.  In the Explorer pane, expand the **frontend** folder and then expand the **contoso_hotel** folder.

1.  Select **views.py**. The file displays in the right side of the Visual Studio Code window.

1.  Delete all code between the following region markers in the code (at or around lines 9 - 304):

    ```-nocopy
    #region -------- BACKEND API ENDPOINTS --------
    #endregion -------- BACKEND API ENDPOINTS -------- 
    ```  

    ![qhkyv58o.png](instructions232686/qhkyv58o.png)

1.  Locate the line of code that imports dblayer (at or around line 4). 

    ![c16t85vh.png](instructions232686/c16t85vh.png)

1.  Remove **dblayer,**.

    ![1pqgxt9o.png](instructions232686/1pqgxt9o.png)

    >{: .important } Do not forget to delete the comma after **dblayer**.

1.  Locate the code that checks to see if the database is set up (at or around lines 22-26):

    ![7xe8gkmv.png](instructions232686/7xe8gkmv.png)

1.  Delete the code that performs the database check.

    ![l338dtbt.png](instructions232686/l338dtbt.png)

1.  Save and close the file.

1.  In the Visual Studio Code Explorer pane, select **Dockerfile**. The file displays in the right side of the Visual Studio Code window.

    ![bndhhefz.png](instructions232686/bndhhefz.png)

1.  Locate the code that installs the mssql odbc driver (at or around lines 17-23):

    ![zwgu2ey9.png](instructions232686/zwgu2ey9.png)

1.  Delete the code hat installs the mssql odbc driver.

    ![l673ddid.png](instructions232686/l673ddid.png)

1.  Save and close the file.

1.  In the Visual Studio Code Explorer pane, select **requirements.txt**. The file displays in the right side of the Visual Studio Code window.

    ![8tm5egdx.png](instructions232686/8tm5egdx.png)

1.  Delete the pyodbc and psycopg2-binary libraries.

    ![00z3g507.png](instructions232686/00z3g507.png)

1.  Save and close the file.

1.  In the Explorer pane, expand the **backend** folder and then expand the **contoso_hotel** folder.

1.  Select **views.py**. The file displays in the right side of the Visual Studio Code window.

1.  Delete all code between the following region markers in the code (lines 309 - 332):

    ```
    #region -------- FRONTEND API ENDPOINTS --------
    #endregion -------- FRONTEND API ENDPOINTS -------- 
    ```  

    ![zo0ce49i.png](instructions232686/zo0ce49i.png)

1.  Save and close the file.

1.  Leave Visual Studio Code open. You will run addtional commands in the next task.



# Task 03 - Build the containers for front-end and back-end components and push the containers to Azure

<!--- Estimated time: 20 minutes---> 

## Introduction

You ran the legacy ContosoHotel app as a single Docker container. You have split up the front-end and back-end components into separate folders. Now, it is time to build separate containers for front-end and back-end components and push the containers to ACR.


## Description

In this task, you will 

The key steps are as follows:

1. Build separate containers for front-end and back-end application components.
1. Run the `az containerapp env create` cmdlet to create an ACR environment for the app.
1. Create container apps for front-end and back-end components.
1. Run the `az containerapp ingress cors` command to manage Cross-Origin Resource Sharing (CORS) policies for the container apps.

## Success Criteria

- You have created Docker containers for front-end and back-end application components
- You have created an ACR enviornment and container apps
- You have configured CORS policies 

## Learning Resources

- [**az containerapp create**](https://learn.microsoft.com/en-us/cli/azure/containerapp?view=azure-cli-latest#az-containerapp-create )
- [**az containerapp env**](https://learn.microsoft.com/en-us/cli/azure/containerapp/env?view=azure-cli-latest )
- [**az containerapp ingress cors**](https://learn.microsoft.com/en-us/cli/azure/containerapp/ingress/cors?view=azure-cli-latest )


## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

In this task you will build a Docker container for the updated app front-end components.

1.  In the list of resources, locate the Container Registry instance. Update the following variable to use the name of the instance that you recorded in Exercise 02 Task 03.

    ```
    $ACR_NAME="XXXXXXXXXXXXXXXXXX"
    ```

1.  Update the value for the $PATH_TO_UPDATED_APP variable to point to the Downloads\UpdatedApp folder on your machine. Enter the following commands at the Terminal window prompt. These commands switch the context to the folder that contains the updated app components.

    ```
    $PATH_TO_UPDATED_APP = "C:\Users\ADMIN\Downloads\UpdatedApp"
    cd $PATH_TO_UPDATED_APP
    ```

1.  In Visual Studio Code, enter the following command at the Terminal window prompt. This command ensures that you are working in the correct folder.

    ```
    cd  $PATH_TO_UPDATED_APP\Frontend
    ```

    ![fno1amvk.png](instructions232686/fno1amvk.png)

1.  Enter the following command at the Terminal window prompt. This command builds the container for the front-end app components.

    ```
    docker pull python:slim-bookworm
    docker build -t "pycontosohotel-frontend:v1.0.0" .
    ```

    >{: .note } It may take 2-3 minutes to build the Docker container.

    ![k6aogw3d.png](instructions232686/k6aogw3d.png)

1.  Enter the following commands at the Terminal window prompt. These commands tag the front-end container and push the container to ACR.

    ```
    docker tag "pycontosohotel-frontend:v1.0.0" "$ACR_NAME.azurecr.io/pycontosohotel-frontend:v1.0.0"
    docker push "$ACR_NAME.azurecr.io/pycontosohotel-frontend:v1.0.0"
    ```

    ![u9e5rz66.png](instructions232686/u9e5rz66.png)

1.  Enter the following commands at the Terminal window prompt. These commands switch the context to the Backend folder and then build the Docker container for the back-end app components.

    ```
    cd  $PATH_TO_UPDATED_APP\Backend
    docker pull python:slim-bookworm
    docker build -t "pycontosohotel-backend:v1.0.0" .
    ```

    >{: .note } It may take 2-3 minutes to build the Docker container.

1.  Enter the following commands at the Terminal window prompt. These commands tag the back-end container and push the container to ACR.

    ```
    docker tag "pycontosohotel-frontend:v1.0.0" "$ACR_NAME.azurecr.io/pycontosohotel-backend:v1.0.0"
    docker push "$ACR_NAME.azurecr.io/pycontosohotel-backend:v1.0.0"
    ```

1.  In Visual Studio Code, enter the following commands at the Terminal window prompt. These commands register app providers.

    ```
    az provider register --namespace Microsoft.App
    az provider register --namespace Microsoft.OperationalInsights
    ```

    >{: .note } It may take 2-3 minutes for these commands to complete.

1.  Update the value of the $AZURE_REGION variable to use the region that you selected in Exercise 01 Task 01.

    ```
    $AZURE_REGION="XXXXXXXXXXXXX"
    ```

1.  Open a web browser and go to the [**Azure portal**](https://portal.azure.com). Select the **ContosoHotel** resource group.

1.  Enter the following commands at the Terminal window prompt. These commands create the container app environment.

    ```
    $CONTOSO_HOTEL_ENV = "contosoenv$(Get-Random -Minimum 100000 -Maximum 999999)"
    $CONTOSO_ACR_CREDENTIAL = az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv
    az containerapp env create --name "$CONTOSO_HOTEL_ENV" --resource-group "ContosoHotel" --location "$AZURE_REGION"
    Write-Host -ForegroundColor Green  "Default Domain is: $(az containerapp env show --name "$CONTOSO_HOTEL_ENV" --resource-group "ContosoHotel" --query "properties.defaultDomain" -o tsv)"
    ```

    >{: .note } It may take 2-3 minutes for these commands to complete.

    ![lmve6yr2.png](instructions232686/lmve6yr2.png)  

1.  Enter the following commands at the Terminal window prompt. These commands create the container app for the front-end app components.

    ```
    az containerapp create --name "frontend" --resource-group "ContosoHotel" --environment "$CONTOSO_HOTEL_ENV" -- "$ACR_NAME.azurecr.io/pycontosohotel-frontend:v1.0.0" --target-port 8000 --ingress external --transport http --registry-server "$ACR_NAME.azurecr.io" --registry-username "$ACR_NAME" --registry-password "$CONTOSO_ACR_CREDENTIAL" --env-vars "API_BASEURL=$CONTOSO_BACKEND_URL"
$CONTOSO_FRONTEND_URL = "https://$(az containerapp show --name "frontend" --resource-group "ContosoHotel" --query 'properties.configuration.ingress.fqdn' -o tsv)"
Write-Host -ForegroundColor Green  "Frontend URL is: $CONTOSO_FRONTEND_URL"
    ```

    ![zlhef23n.png](instructions232686/zlhef23n.png)

    >{: .note } Record the value for the Frontend URL. You will need to supply the URL in Step 17 in this task.

1.  Replace the *ENTER_CONNECTION_STRING_FOR_DATABASE* placeholder text in the following command with the connection string you recorded in the previous lab. Enter the command at the Visual Studio Code Terminal window prompt and then press the **Enter** key. These commands create the container app for the back-end app components.

    ```
    az containerapp create --name "backend" --resource-group "ContosoHotel" --environment "$CONTOSO_HOTEL_ENV" -- "$ACR_NAME.azurecr.io/pycontosohotel-backend:v1.0.0" --target-port 8000 --ingress external --transport http --registry-server "$ACR_NAME.azurecr.io" --registry-username "$ACR_NAME" --registry-password "$CONTOSO_ACR_CREDENTIAL" --env-vars "POSTGRES_CONNECTION_STRING='ENTER_CONNECTION_STRING_FOR_DATABASE'"
$CONTOSO_BACKEND_URL = "https://$(az containerapp show --name "backend" --resource-group "ContosoHotel" --query 'properties.configuration.ingress.fqdn' -o tsv)"
Write-Host -ForegroundColor Green  "Backend URL is: $CONTOSO_BACKEND_URL"
    ```

    ![zlhef23n.png](instructions232686/zlhef23n.png)

1.  Replace the *FRONTEND_URL* placeholder text in the following command with the URL that you recorded in Step 12 of this task. Enter the following command at the Terminal window prompt. These commands configures communication between the front-end and back-end containers.

    ```
    az containerapp ingress cors --name "backend" --resource-group "ContosoHotel" --allowed-origins "FRONTEND_URL" --allowed-methods '*'
    ```

1.  Leave Visual Studio Code open. You will run addtional commands in the next exercise.

</details>



# Exercise 04 - Set up Azure resources and extract data from hotel brochures

## Lab Scenario

When people are making travel plans, they often select a hotel based on the location of the hotel or the amenities that the hotel offers. Most hotel websites make it easy to search their hotels by date and location. However, it it can be challenging to narrow down the list so that only hotels with specific amenities display.

Contoso wants to build a chatbot that helps potential guests find a hotel that meets their needs. For this solution, you will upload PDF versions of the Contoso Hotel brochures to an Azure Storage account. Then, you will use Azure Search service and Azure OpenAI service to scan the PDFs and extract information that a chatbot can use to respond to guest inquiries.

## Objectives

After you complete this lab, you will be able to:

- Create an Azure Blob Storage accountand a storage container
- Upload hotel brochures to the storage container
- Create an Azure Search Service instance
- Create an Azure OpenAI service instance and deploy models to the instance
- Configure managed identities for the services
- Extract data from the brochures and test the search index

## Exercise Duration

Estimated time to complete this exercise: *45 minutes*



# Task 01 - Create an Azure Blob Storage account and upload files

<!--- Estimated time: 7 minutes---> 

## Introduction



## Description

In this task, you will create an Azure Blog Storage account and then upload a set of PDF files to the storage account. Each PDF file is a brochure for one of the hotels represented in the Contoso Hotels app.

The key steps are as follows:

1. Create an Azure Storage account and container.
1. Download the folder which containst the hotel brochures to your local machine.
1. Upload the brochures to the storage container.

## Success Criteria

- You have uploaded the hotel brochures to the container in the Azure Storage account. 

## Learning Resources

- [**Create an Azure Storage account**](https://learn.microsoft.com/en-us/training/modules/create-azure-storage-account/ )
- [**Create a storage container**](https://learn.microsoft.com/en-us/training/modules/create-azure-storage-account/5-exercise-create-a-storage-account)
- [**GitHub repository with assets for this workshop**](https://github.com/microsoft/TechExcel-Modernize-applications-to-be-AI-ready )

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>


1.  In Visual Studio Code, enter the following commands at the Terminal window prompt. This command ensures that you are still signed in.

    ```
    az login    
    ```

1.  Update the value of the $AZURE_REGION variable to use the region that you selected in Exercise 01 Task 01.

    ```
    $AZURE_REGION ="XXXXXXXXXXXXX"
    ```

1.  In Visual Studio Code, enter the following commands at the Terminal window prompt. These commands create a storage account and a storage container.
   
    ```
    $CONTOSO_STORAGE_ACCOUNT_NAME="contososa$(Get-Random -Minimum 100000 -Maximum 999999)"
    az storage account create --name $CONTOSO_STORAGE_ACCOUNT_NAME --resource-group ContosoHotel --location $AZURE_REGION --sku Standard_LRS
    az storage container create --name brochures --account-name $CONTOSO_STORAGE_ACCOUNT_NAME
    ```
1.  Open a web browser and go to [**GitHub repository for this workshop**](https://github.com/microsoft/TechExcel-Modernize-applications-to-be-AI-ready ).

1.   Open File Explorer on your computer and go to the Downloads folder. Update the following variable to use the path for your Downloads folder.

    ```
    $PATH_TO_DOWNLOADS_FOLDER = "C:\Users\XXXXXXXX\Downloads"
    ```

1.  In Visual Studio Code, enter the following commands at the Terminal window prompt. This command clones assets for this workshop including hotel brochures from a GitHub repository to a folder in your Downloads folder. 

    ```
    git clone https://github.com/microsoft/TechExcel-Modernize-applications-to-be-AI-ready "$PATH_TO_DOWNLOADS_FOLDER\AssetsRepo"
    ```

    ![8t6tp7c0.png](instructions232686/8t6tp7c0.png)


1.  Enter the following command at the Terminal window prompt. This command uploads the brochures to the storage container that you created earlier in this task. 

    ```
    az storage blob upload-batch --account-name $CONTOSO_STORAGE_ACCOUNT_NAME --destination brochures --source "$PATH_TO_DOWNLOADS_FOLDER\AssetsRepo\Assets\PDFs" --pattern "*.pdf" --overwrite
    ```

    ![rl2qes66.png](instructions232686/rl2qes66.png)

1.  Leave Visual Studio Code open. You will run addtional commands in the next exercise.

</details>


# Task 02 - Create additional Azure services

<!--- Estimated time: 20 minutes---> 

## Introduction

Azure AI services is a set of cloud-based APIs that you can use in AI applications and data flows. This lab uses Azure OpenAI Service and Azure Search Service to scan and index the data from the hotel brochures. 

## Description

In this task, you will provision both services. Then, you will deploy required AI models to the Azure OpenAI service that you created.

The key steps are as follows:

1. Create an Azure AI Services account.
1. Deploy the text-embedding-ada-00 and gpt-4o models to the account.
1. Create an Azure Search Services instance.

## Success Criteria

- You have successfully deployed the text-embedding-ada-00 and gpt-4o models
- You have successfully provisioned an Azure Search Services instance

## Learning Resources

- [**Choose an Azure AI Services technology**](https://learn.microsoft.com/en-us/azure/architecture/data-guide/technology-choices/cognitive-services)
- [**Azure OpenAI Service**](https://azure.microsoft.com/en-us/products/ai-services/openai-service/)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary> 

1.  Enter the following commands at the Terminal window prompt. These commands create the Azure OpenAI Service instance.

    ```
    $CONTOSO_AI_NAME="contosoai$(Get-Random -Minimum 100000 -Maximum 999999)"
    az cognitiveservices account create --name $CONTOSO_AI_NAME --resource-group ContosoHotel --kind OpenAI --sku S0 --location $AZURE_REGION --assign-identity --yes 
    ```

    >{: .note } It may take 10-15 minutes for provisioning to complete. You can check the status of it by going to **Azure** -> Search for '**Azure OpenAI**' -> Select '**contosoai[xxxxxx]**' and it should load once provisioned.

    ![05oyjgqj.jpg](instructions232686/05oyjgqj.jpg)

1.  Enter the following commands at the Terminal window prompt. These commands deploy models to the Azure OpenAI Service instance that you created.

    ```
    az cognitiveservices account deployment create --name $CONTOSO_AI_NAME --resource-group ContosoHotel --deployment-name "ada" --model-name "text-embedding-ada-002" --model-version "2" --model-format "OpenAI" --sku-capacity "200" --sku-name "Standard"
    az cognitiveservices account deployment create --name $CONTOSO_AI_NAME --resource-group ContosoHotel --deployment-name "gpt-4o" --model-name "gpt-4o" --model-version "2024-05-13" --model-format "OpenAI" --sku-capacity "200" --sku-name "GlobalStandard"
    ```

    >{: .important } After you create the Cognitive services account and deploy the models, it may take 10-15 minutes before the services are fully available and ready for Step 3.

    ![hir6ul1m.jpg](instructions232686/hir6ul1m.jpg)

1.  Enter the following commands at the Terminal window prompt. These commands create the Azure Search Service instance.

    ```
    $CONTOSO_SEARCH_SERVICE_NAME="contososrch$(Get-Random -Minimum 100000 -Maximum 999999)"
    az search service create --name $CONTOSO_SEARCH_SERVICE_NAME --resource-group ContosoHotel --sku Basic --location $AZURE_REGION  --auth-options aadOrApiKey --aad-auth-failure-mode http403 --identity-type SystemAssigned
    ```

    >{: .note } It may take 10-15 minutes for provisioning to complete.

1.  Leave Visual Studio Code open. You will run addtional commands in the next task.

</details>


# Task 03 - Configure managed identities for deployed resources

<!--- Estimated time: 5 minutes---> 

## Introduction

Managing permissions and access for users and Azure resources can be challenging. Managed identities help you deploy secure solutions on Azure without the need to manage credentials. You can create system-assigned and user-assigned managed identities. For this lab, you will use system-assgined managed identities. You enable this type of identity directly on the Aure resource.

## Description

In this task, you will create a set of managed identities so that the various Azure resources you created can communicate with each other.

The key steps are as follows:

1. Configure the Azure OpenAI and Azure Search instances to use system-assigned managed identities.
1. Configure a managed identity to allow the Azure Search and Azure OpenAI instances to access the Azure Blob Storage account.
1. Configure a  managed identity to allow Azure Search instance to access the Azure OpenAI Service instance.
1. Configure a  managed identity to allow Azure OpenAI Service instance to access the  Azure Search instance.

## Success Criteria

- You have configured managed identities so that the Azure Blob Storage account, Azure Search Service instance, and Azure OpenAI Service instance can communicate with each other. 

## Learning Resources

- [**Implement managed identities**](https://learn.microsoft.com/en-us/training/modules/implement-managed-identities/
)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following commands at the Terminal window prompt. These commands configure both the Azure Search and Azure OpenAI instances to use system-assigned managed identities.

    ```
    az search service update --name $CONTOSO_SEARCH_SERVICE_NAME --resource-group ContosoHotel --identity-type SystemAssigned
    az cognitiveservices account identity assign --name $CONTOSO_AI_NAME --resource-group ContosoHotel
    ```

1.  Enter the following commands at the Terminal window prompt. These commands allow the Azure Search and Azure OpenAI instances to access the Azure Blob Storage account.

    ```
    $SEARCH_IDENTITY=$(az search service show --name $CONTOSO_SEARCH_SERVICE_NAME --resource-group ContosoHotel --query identity.principalId -o tsv)
    $AI_IDENTITY=$(az cognitiveservices account identity show --name $CONTOSO_AI_NAME --resource-group ContosoHotel --query principalId -o tsv)
    $STORAGE_SCOPE=$(az storage account show --name $CONTOSO_STORAGE_ACCOUNT_NAME --resource-group ContosoHotel --query id -o tsv)
    az role assignment create --role "Storage Blob Data Contributor" --assignee $SEARCH_IDENTITY --scope $STORAGE_SCOPE
    az role assignment create --role "Storage Blob Data Contributor" --assignee $AI_IDENTITY --scope $STORAGE_SCOPE
    ```

1.  Enter the following commands at the Terminal window prompt. These commands allow the Azure Search to access the Azure OpenAI Service instance you created.

    ```
    $AI_SCOPE=$(az cognitiveservices account show --name $CONTOSO_AI_NAME --resource-group ContosoHotel --query id -o tsv)
    az role assignment create --role "Cognitive Services OpenAI Contributor" --assignee $SEARCH_IDENTITY --scope $AI_SCOPE
    ```

1.  Enter the following commands at the Terminal window prompt. These commands allow the Azure OpenAI Service instance to access the Azure Search Service instance you created.

    ```
    $SEARCH_SCOPE=$(az search service show --name $CONTOSO_SEARCH_SERVICE_NAME --resource-group ContosoHotel --query id -o tsv)
    az role assignment create --role "Search Index Data Contributor" --assignee $AI_IDENTITY --scope $SEARCH_SCOPE
    az role assignment create --role "Search Index Data Reader" --assignee $AI_IDENTITY --scope $SEARCH_SCOPE
    az role assignment create --role "Search Service Contributor" --assignee $AI_IDENTITY --scope $SEARCH_SCOPE
    ```
1.  Leave Visual Studio Code open. You will run addtional commands in the next task.

</details>



# Task 04 - Configure Azure Search to extract data from the brochures and test the search index

<!--- Estimated time: 10 minutes---> 

## Introduction



## Description

In this task, you will use Azure Search to import and vectorize data from the hotel brochures. You will then test the index.

The key steps are as follows:

1. Launch the import and vectorize data and connect to Azure Blob Storage.
1. Vectorize text from the brochures.
1. Index the data.
1. Test the index.

## Success Criteria

- You have successfully completed all steps in the Import and vectorize data wizard. 
- You have tested the search index by using Search Explorer and can view results.

## Learning Resources

- [**Azure Search Overview**](https://learn.microsoft.com/en-us/azure/search/search-what-is-azure-search)
- [**Integrated data chunking and embedding in Azure AI Search**](https://learn.microsoft.com/en-us/azure/search/vector-search-integrated-vectorization)
- [**Quickstart: Vectorize text and s by using the Azure portal**](https://learn.microsoft.com/en-us/azure/search/search-get-started-portal-import-vectors?tabs=sample-data-storage%2Cmodel-aoai%2Cconnect-data-storage)
- [**Manage your Azure AI Search service with the Azure CLI**](https://learn.microsoft.com/en-us/azure/search/search-manage-azure-cli)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  1.  Open a browser window and go to [**Azure portal**](https://portal.azure.com). Sign in to Azure.

1.  On the Azure Home page, select **Resource groups** and then select **ContosoHotel**.

1.  In the list of resources that displays, select the Azure Search service instance from the list of resources.

1.  On the Overview page for the Search service, select **Import and vectorize data**.

    ![o6vixwo1.png](instructions232686/o6vixwo1.png)

1.  On the Connect to your data page, select **Azure Blob Storage**.

    ![rkshmz9t.png](instructions232686/rkshmz9t.png)

1.  On the Configure your Azure Blob Storage page, enter the following information and then select **Next**. Wait while Azure validates the connection:

    | Setting | Value |
    |:---------|:---------|
    | Storage acccount   | **contosoa[xxxxxx]**   |
    | Blob container   | **brochures**| 

    >{: .important } The data import wizard will fail at this step if you have not uploaded any brochures to the storage container.</br></br> You may see an error stating "No access to this subscription, or no Azure OpenAI service available under it". If this error displays, exit from the Import and vectorize data wizard, wait 10 minutes, and try again.

1.  On the *Vectorize your text* page, enter the following information:

    | Setting | Value |
    |:---------|:---------|
    | Kind   | **Azure OpenAI**  |
    | Azure OpenAI service  | Select the name for the Azure OpenAI service instance that you created|  
    | Model deployment | **ada** |
    |Authentication type | **System assigned identity**|

1.  Select the checkbox to acknowledge that connecting to Azure OpenAI service will incur costs and then select **Next**. Select **Next** again to skip the Vecorize and enrich your s step.

    ![vgpo13i3.png](instructions232686/vgpo13i3.png)

1.  On the *Advanced settings* page, select **Enable semantic ranker**. In the Shedule indexing drop-down list, select **Once**.

    ![9wx3fylu.png](instructions232686/9wx3fylu.png)

1.  On the *Review and create* page, enter **brochures-vector** in the Objects name prefix text field and then select **Create**. Wait for the the creation process to complete and select **Close**.

    ![dblr2z51.png](instructions232686/dblr2z51.png)

1.  In the left navigation pane for the Search Service instance, in the Search management section, select **Indexers**.

1.  Review the value for the Status column.


1.  In the left navigation pane for the Search Service instance, in the Search management section, select **Indexes** and then select the **brochures-vector** index.

1.  On the brochures-vector page, select **Search explorer**.

1.  In the Search field, enter **Athens** and then select **Search**.

1.  Review the output from the search operation. The results should list data about Athens and shold also contain a text vector.

1.  Leave Visual Studio Code open. You will run addtional commands in the next exercise.




# Exercise 05 - Configure an AI Hub and Promptflow

There are a lot of ways to create a chatbot. For this lab, you will use Promptflow within Azure AI Studio. Azure OpenAI Prompt Flow is a development tool designed to streamline the entire lifecycle of AI applications powered by Large Language Models (LLMs). Prompt Flow simplifies the process of prototyping, experimenting, iterating, and deploying AI applications.

#### **What you will learn**

After completing the tasks in this exercise, you will be able to:

- Create a postgresql readonly user
- Create and configure an AI Hub instance
- Import a pre-built flow into PromptFlow
- Configure and test the flow

## Exercise Duration

* **Estimated Time:** 60 minutes



# Task 01 - Create a postgresql user and set up an AI Hub and PromptFlow

<!--- Estimated time: 20 minutes---> 

## Introduction

An Azure AI Studio Hub is a central resource within Azure AI Studio that helps teams manage, collaborate, and organize their AI projects. 

## Description

In this task, you will create a hub and then create a project within the hub. You will also create a PostgreSQL user so the that flow can access the database records.

The key steps are as follows:

1. Create a user for the PostgreSQL database that allows the chatbot read-only access to the Hotels, Visitors, and Bookings tables.
1. Set up and configure an AI Studio Hub.
1. Create a project in the hub.


## Success Criteria

- You have successfully created a user in the PostgreSQL database
- You have created a new AI Studio Hub and created a project

## Learning Resources

- [**Secure Azure Database for PostgreSQL**](https://learn.microsoft.com/en-us/training/modules/secure-azure-database-for-postgresql/)
- [**Develop your own custom copilots with Azure AI Studio**](https://learn.microsoft.com/en-us/training/paths/create-custom-copilots-ai-studio/)
- [**Get started with prompt flow**](https://learn.microsoft.com/en-us/training/modules/get-started-prompt-flow-ai-studio/)
- [**Prompt flow in Azure AI Studio**](https://learn.microsoft.com/en-us/azure/ai-studio/how-to/prompt-flow)
- [**Add a new connection in Azure AI Studio**](https://learn.microsoft.com/en-us/azure/ai-studio/how-to/connections-add)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Open a browser window and go to [**Azure portal**](https://portal.azure.com).

1.  Search for and select the PostgreSQL database that you created in a previous exercise.

    ![hlodbtra.png](instructions232686/hlodbtra.png)

1.  On the menu bar for the database server, select **Cloud Shell** and then select **Bash** in the Clous Shell pane.

    ![gpk0nqqq.png](instructions232686/gpk0nqqq.png)

1.  Select your subscription from the dropdown list and then select **Apply**.

1.  Replace the value for *POSTGRESQL_SERVERNAME* with the Server name that appears in the Overview section for your database server. Then, enter the following commands at the Cloud Shell prompt. These commands connect to the database.

    ```
    export PGHOST="POSTGRESQL_SERVERNAME"
    export PGUSER="contosoadmin"
    export PGPORT="5432"
    export PGDATABASE="pycontosohotel"
    export PGPASSWORD="myLittleSecret111!!!"
    psql
    ```

1.  Enter the following SQL statement at the Cloud Shell prompt. This statement creates a read-only user for the Promptflow chatbot:
    
    ```
    CREATE USER promptflow WITH PASSWORD '1234ABCD!';
    ```

1.  Enter the following SQL statementz at the Cloud Shell prompt. These statements grant the user access to the database tables.
    
    ```
    GRANT SELECT ON TABLE hotels TO promptflow;
    GRANT SELECT ON TABLE bookings TO promptflow;
    GRANT SELECT ON TABLE visitors TO promptflow;
    GRANT EXECUTE ON FUNCTION getroomsusagewithintimespan TO promptflow;
    ```

    ![qq3r508d.png](instructions232686/qq3r508d.png)

1.  Return to Visual Studio Code. Enter the following command at the Terminal window prompt. This command creates a unique name for an AI Hub.

    ```
    $AI_HUB_NAME="ai-hub$(Get-Random -Minimum 100000 -Maximum 999999)"
    Write-Host -ForegroundColor Green  "AI Hub name is: " $AI_HUB_NAME

    ```

    ![azenz3uq.png](instructions232686/azenz3uq.png)

    >{: .note } Record the name of the AI Hub. You will use the name later in this task.

1.  Open a browser window and go to **https://ai.azure.com/**.

1.  On the Azure AI Studio home page, select **Sign in**. 

    ![w8nl61zo.png](instructions232686/w8nl61zo.png)

1.  If prompted, enter your credentials to sign into Azure AI Studio:

1.  In the left navigation pane, in the Management section, select **All Resources**.

1.  On the page that displays, select **+New hub**.

    ![yrjv147m.png](instructions232686/yrjv147m.png)


1.  Configure the hub by using the values in the following table. Leave all other settings at their default values. Wait for the validation to complete and then select **Next**.

    | Setting | Value |
    |:---------|:---------|
    | Hub name   | Use the AI Hub name that you recorded in step 8 of this task.  |
    | Subscription  | Use the subscription where you deployed all other resources.|
    | Resource group | **ContosoHotel** |
    | Location |Enter the location for the region where you deployed all other resources**|
    | Connect Azure AI Services or OpenAI | Select the name for the OpenAI service instance that you deployed |

    ![0bj6saco.png](instructions232686/0bj6saco.png)
    
1.  On the Review and finish page, select **Create**. 

    ![s5j5umv2.png](instructions232686/s5j5umv2.png)

1.  Wait until the new AI hub, storage account, and key vault are created.

    ![y7yaln2q.png](instructions232686/y7yaln2q.png)

    >!ALERT] While the resources are being provisioned, take a screenshot of the page that displays. You will need to enter the AI Hub name and the Storage account name later in this task.

1.  Open a browser window and go to [**Azure portal**](https://portal.azure.com).

1.  In the Search field at the top of the home page, enter **Resource groups** and then select **ContosoHotel**.

1.  Filter the list of resources by using the **Type** column. You should see two storage accounts. The first is the storage account that you created earlier in the lab. The other was created by the AI Hub. Select this storage account.

    >{: .note } The name for the newly created storage account will start with **st**. You can also use the screenshot you captured in Step 16 to identify the storage account name to use here.

1.  In the left navigation pane for the storage account, select **Access Control (IAM)**.

1.  On the Access Control (IAM) page, on the Grant access to this resource tile, select **Add role assignment**.

    ![pt0jgle5.png](instructions232686/pt0jgle5.png)

1.  In the search field, enter **Storage Blob Data Owner** and then select **Storage Blob Data Owner** from the list of search results. Select **Next**.

    ![26h4260w.png](instructions232686/26h4260w.png)

1.  On the Add role assignment page, select **+Select members**.

1.  In the Select members pane, search for and select your user name.

1.  Select **Select** to close the Select members pane. Then, select **Review + assign** twice.

1.  On the Access Control (IAM) page, on the Grant access to this resource tile, select **Add role assignment** to add a second role assignment.

1.  In the search field, enter **Storage Blob Data Reader** and then select **Storage Blob Data Reader** from the list of search results. Select **Next**.

    ![xo38uaxm.png](instructions232686/xo38uaxm.png)

1.  On the Add role assignment page, select **+Select members**.

1.  In the Select members pane, search for and select the name for the AI Hub that you created in Step 8 of this taska.

1.  Select **Select** to close the Select members pane. Then, select **Review + assign** twice.

</details>


# Task 02 - Import and configure a flow

<!--- Estimated time: 40 minutes---> 

## Introduction

A flow encapsulates the logic that tells the chatbot what it can do and how to do things. Creating a flow can be complicated. For this lab, you will use a pre-built flow. The flow uses the OpenAI API to directly query the Azure Search index. 

The flow collects inputs and performs several steps. The diagram below depicts the logical operations that the flow performs.

![n9s08385.png](instructions232686/n9s08385.png)


>>{: .note } AI Studio also includes an integrated vector search feature. We did not specify the use of the integrated vector search feature for this lab because we cannot deploy a flow that uses the feature to a container at this time.

## Description

In this task, you will import a pre-built flow, configure flow settings, and then test the flow.

The key steps are as follows:

1. Import a pre-built flow into the project.
1. Configure the flow.
1. Test the flow


## Success Criteria

- You have imported and configured a pre-built flow.
- You have tested the flow and confirmed that the flow returns appropriate results.

## Learning Resources

- [**Develop your own custom copilots with Azure AI Studio**](https://learn.microsoft.com/en-us/training/paths/create-custom-copilots-ai-studio/)
- [**Get started with prompt flow**](https://learn.microsoft.com/en-us/training/modules/get-started-prompt-flow-ai-studio/)
- [**Prompt flow in Azure AI Studio**](https://learn.microsoft.com/en-us/azure/ai-studio/how-to/prompt-flow)
- [**Add a new connection in Azure AI Studio**](https://learn.microsoft.com/en-us/azure/ai-studio/how-to/connections-add)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Return to the Azure AI Studio browser window. 

    >{: .note } If you closed the window, go to [**Azure AI Studio**](ai.azure.com).

1.  In the left navigation pane for the hub, select **Hub Overview**.

1.  On the Overview page for the hub, locate the Projects section and select **+ New project**.

1.  In the Project name field, enter **contosopf** and then select **Create a project**. Wait for the project to be created.

    ![7sngbnny.png](instructions232686/7sngbnny.png)

1.  In the left navigation pane for the project page, in the Tools section, select **Prompt flow**.

    ![u25i702l.png](instructions232686/u25i702l.png)

1.  On the *Create, iterate, and debug your orchestration flows* page, select **+Create**.

1.  On the *Create a new flow* page, in the Upload from local section, select **Upload**.

    ![j8eqlo0o.png](instructions232686/j8eqlo0o.png)

1.  On the *Upload from local* page, select **Zip file** and then select **Browse**. Go to the Downloads\AssetsRepo\Assets folder.

    >{: .note } You created this folder in Exercise 04 Task 01 when you cloned the GitHub repository to acquire the hotel brochures.

1.  Select **chatflow-oai-datasources.zip** and then select **Open**. 

1.  Select **Upload** to import the zip file into the project. 

    >{: .note } It may take several minutes to upload the flow.

1.  In the middle pane for the flow, you will see one flow for each of the four logical steps in the flow. Review the information in each tile. This will help you understand how the flow functions.

1.  Open a new browser window and go to [**Azure portal**](https://portal.azure.com).

1.  Search for and select the PostgreSQL database that you created in a previous exercise.

    ![hlodbtra.png](instructions232686/hlodbtra.png)

1.  In the Overview section for the database, copy the value for Server name. You will past the value into a field in Step 18 of this task.

1.  In the left navigation pane for the flow, select **Settings** and then select **+ New connection**.

    ![zpzeywmf.png](instructions232686/zpzeywmf.png)

1.  On the *Add a connection to external assets* page, select **Custom keys**.

    ![b701wgpu.png](instructions232686/b701wgpu.png)

1.  Select **+ Add key value pairs**.

1.  Enter the following information. 

    | Field | Value |
    |:---------|:---------|
    | Custom keys      | **hostname**   |
    | Value   | Use the server name you copied in Step 14 of this lab|

1.  Select **+ Add key value pairs**.

1.  Enter the following information. 

    | Field | Value |
    |:---------|:---------|
    | Custom keys      | **user**   |
    | Value   | **promptflow**|

1.  Select **+ Add key value pairs**.

1.  Enter the following information. 

    | Field | Value |
    |:---------|:---------|
    | Custom keys      | **port**   |
    | Value   | **5432**|

1.  Select **+ Add key value pairs**.

1.  Enter the following information. 

    | Field | Value |
    |:---------|:---------|
    | Custom keys      | **database**   |
    | Value   | **pycontosohotel**|

1.  Select **+ Add key value pairs**.

1.  Enter the following information. 

    | Field | Value |
    |:---------|:---------|
    | Custom keys      | **passwd**   |
    | Value   | Use the password from the connection string for the database|
    | Is Secret| Selected|

1.  In the Connection name field, enter **postgresql** and then select **Add connection**. Wait while the connection is created. The connection should resemble the following screenshot:

    ![435pbqb5.png](instructions232686/435pbqb5.png)

1.  In the left navigation pane for the flow, in the Tools section, select **Prompt flow** and then select the prompt flow that you created.

1.  Locate the *check_question_intent* tile. In the Connection field, select the connection that displays.

    ![yk3o4cnl.png](instructions232686/yk3o4cnl.png)

1.  Repeat the process of selecting a connection for each of the following tiles:

    - generate_sql
    - chat_with_data
    - conclude_answer

1.  Select **Start compute session**. This allows you to run and test the chatbot.

1.  Select **chat** to test the flow. 

1.  Enter **Where can I ski?** in the chat prompt and press the **Enter** key. Wait for a response. Your results should resemble the following:

    ![0i58d1im.png](instructions232686/0i58d1im.png)
    
    ![kjpn148g.png](instructions232686/kjpn148g.png).

1.  Start a new converstion and enter **How many free rooms do hotels in Switzerland have grouped by hotel on 2024-10-10?**. Your results should resemble the following:

    ![d4vy2plk.png](instructions232686/d4vy2plk.png)
    
    ![is89pwm5.png](instructions232686/is89pwm5.png)

</details>




# Exercise 06 - Integrate the chatbot with the Contoso Hotel application

At this point you have a chatbot that can query the hotel brochures. In this exercise, you will integrate the chatbot into the updated Contoso Hotel application.


#### **What you will learn**

After completing the tasks in this exercise, you will be able to:

- Run the chtabot locally.
- Containerize the flow and push the flow to ACR.
- Deploy the flow to Azure Contianer apps and configure environment variables.
- Update the Contoso Hotel app to display the chtabot page.

## Exercise Duration

* **Estimated Time:** xx minutes



# Task 01 - Set up Visual Studio Code and run the flow locally

<!--- Estimated time: x minutes---> 

## Introduction



## Description

In this task you will test the chatbot locally before you publish the chatbot.

The key steps are as follows:

1. Configure your development evironment in Visual Studio Code.
1. Create an enviornment file for the chatbot.
1. Create a connection to Azure OpenAI.
1. Run the chatbot locally to test the chatbot.


## Success Criteria

- You have set up your development enviornment.
- You have tested the chatbot locally.

## Learning Resources

- [**Deploy a flow using Docker**](https://microsoft.github.io/promptflow/how-to-guides/deploy-a-flow/deploy-using-docker.html)
- [**Prompt flow documentation**](https://microsoft.github.io/promptflow/reference/pf-command-reference.html#pf-flow)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Open File Explorer and go to the Downloads\AssetsRepo folder.

1.  Double-click **chatflow-oai-datasources.zip**. Select **Extract all** and then select **Extract**.

1.  Launch Visual Studio Code.

1.  From the menu bar, select **File** and then select **Open Folder**.

1.  Select **AssetsRepo** and then select **Select folder**.

1.  Select the option to Trust the authors.

1.  In the Explorer pane, expand **chatflow-oai-datasources**.

1.  Right-click **.env.sample** and then slect **Rename**. Rename the file to **.env**.

1.  Select **.env** to open the file in an Editor window.

1. Update the variables to use the same values that you used in Exercise 05, Task 01, Step 05. Save your changes and close the file.

    ```
    AZURE_OPENAI_ENDPOINT="https://contoso-hotels.openai.azure.com/"
    AZURE_OPENAI_API_KEY="1234567890"
    AZURE_OPENAI_DEPLOYMENT_ID="gpt-4o"
    AZURE_AI_SEARCH_ENDPOINT="https://contoso-hotels.search.windows.net"
    AZURE_AI_SEARCH_INDEX="contoso-hotels-brochures"
    AZURE_AI_SEARCH_API_KEY="1234567890"
    PGHOST="XXXXXXXXXXXXXXXXXXXXX"
    PGPORT="5432"
    PGUSER="contosoadmin"
    PGDATABASE="postgres"
    PGPASSWORD="myLittleSecret111!!!"
    ```
1.  Enter the following command at the Visual Studio Code Terminal window prompt. This command creates a connection to Azure Open AI.

    ```
    pf connection create --file azure_openai.yaml --name open_ai_connection --set api_key=<your_api_key> api_base=<your_api_base>
    ```

1.  Enter the following commands at the Terminal window prompt. These commands create environment variables. 

    ```
    get-content .env | foreach {
    $name, $value = $_.split('=')
    set-content env:\$name $value
    }
    ```

1.  Enter the following commands at the Terminal window prompt. These commands run the flow interactively so that you can peform testing.

    ```
    pf flow test --flow . --interactive
    ```

</details>



# Task 02 - Deploy the flow to Azure Container apps and test the app

<!--- Estimated time: x minutes---> 

## Introduction



## Description

In this task you will prepare the flow for deployment and deploy the flow. You will update the app to display the chatbot page.

The key steps are as follows:

1. Containerize the flow and push the flow to ACR.
1. Deploy the Container app and configure environmental variables.
1. Update the Contoso Hotel app to display the chatbot page


## Success Criteria

- You have updated the app to include the chatbot feature.

## Learning Resources

- [**Deploy a flow using Docker**](https://microsoft.github.io/promptflow/how-to-guides/deploy-a-flow/deploy-using-docker.html)
- [**Promptflow Reference**](https://microsoft.github.io/promptflow/reference/pf-command-reference.html#pf-flow)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>

1.  Enter the following commands in the Visual Studio Code Terminal window prompt. These commands containerize the flow and push the flow to ACR.

    ```
    pf flow build --source . --output docker-dist --format docker
    docker build -t contosohotels.azurecr.io/chatbot:latest ./docker-dist
    az acr login -n contosohotels
    docker push contosohotels.azurecr.io/chatbot:latest
    ```

1.  Enter the following commands in the Visual Studio Code Terminal window prompt. These commands deploy the container to Azure Container Apps and set environment variables.

    ```
    AZURE_OPENAI_ENDPOINT=https://contoso-hotels.openai.azure.com/
    AZURE_OPENAI_API_KEY=1234567890
    AZURE_OPENAI_DEPLOYMENT_ID=gpt-4o
    AZURE_AI_SEARCH_ENDPOINT=https://contoso-hotels.search.windows.net
    AZURE_AI_SEARCH_INDEX=contoso-hotels-brochures
    AZURE_AI_SEARCH_API_KEY=1234567890
    PGHOST="XXXXXXXXXXXXXXXXXXXX"
    PGPORT="5432"
    PGUSER="contosoadmin"
    PGDATABASE="postgres"
    PGPASSWORD="myLittleSecret111!!!"
    ```


Update the frontend frontend
Configure the CHATBOT_BASEURL environment variable in ACA frontend
</details>


   
