---
title: 'Exercise 06 - Integrate the chatbot with the Contoso Hotel application'
layout: default
nav_order: 7
has_children: true
---

# Exercise 06 - Integrate the chatbot with the Contoso Hotel application

At this point you have a chatbot that can query the hotel brochures. In this exercise, you will integrate the chatbot into the updated Contoso Hotel application.


#### **What you will learn**

After completing the tasks in this exercise, you will be able to:

- Run the chtabot locally.
- Containerize the flow and push the flow to ACR.
- Deploy the flow to Azure Contianer apps and configure environment variables.
- Update the Contoso Hotel app to display the chtabot page.

## Exercise Duration

* **Estimated Time:** 30 minutes

---

# Task 01 - Set up Visual Studio Code and run the flow locally

<!--- Estimated time: 15 minutes---> 

## Introduction



## Description

In this task you will test the chatbot locally before you publish the chatbot.

The key steps are as follows:

1. Configure your development evironment in Visual Studio Code.
1. Create an enviornment file for the chatbot.
1. Create a connection to Azure OpenAI.
1. Run the chatbot locally to test the chatbot.


## Success Criteria

- You have set up your development enviornment.
- You have tested the chatbot locally.

## Learning Resources

- [**Deploy a flow using Docker**](https://microsoft.github.io/promptflow/how-to-guides/deploy-a-flow/deploy-using-docker.html)
- [**Prompt flow documentation**](https://microsoft.github.io/promptflow/reference/pf-command-reference.html#pf-flow)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>


1. Open File Explorer and go to the **Downloads\AssetsRepo\Assets** folder.

1. Double-click **lab-6-promptflow.zip**. Select **Extract all** and then select **Extract**.

1. Launch Visual Studio Code as an administrator.

1. From the menu bar, select **File** and then select **Open Folder**.

1. Navigate into **AssetsRepo/Assets**, select **lab-6-promptflow**, and then select **Select folder**.

    ![7s3lyr99.jpg](../../media/7s3lyr99.jpg)

1. Select the option to Trust the authors.

1. In the Explorer pane, expand **lab-6-promptflow**.

1. Right-click **.env.sample** and then select **Rename**. Rename the file to **.env**.

1. Select **.env** to open the file in an Editor window.

1. Update the variables to use the same values that you used in Exercise 05, Task 01, Step 05.

    ```
    AZURE_OPENAI_ENDPOINT="https://azureopenai62143490.openai.azure.com/"
    AZURE_OPENAI_API_KEY="08c96b97791e44ea83c4dff67a76eb32"
    AZURE_OPENAI_DEPLOYMENT_ID="gpt-4o"
    AZURE_AI_SEARCH_ENDPOINT="https://contososrch799498.search.windows.net"
    AZURE_AI_SEARCH_INDEX="brochures-vector"
    AZURE_AI_SEARCH_API_KEY="ctkSfXrdBMgyYEIFOkECVmrWrdcRioV7wyAfqRVSNGAzSeAsUWls"
    PGHOST="mg32xpzwcffkg.postgres.database.azure.com"
    PGPORT="5432"
    PGUSER="promptflow"
    PGDATABASE="pycontosohotel"
    PGPASSWORD="1234ABCD!"
    ```

	{: .note }
	> To locate the values for AZURE_OPENAI_ENDPOINT and AZURE_OPENAI_API_KEY, in the Azure portal, select the Azure OpenAI resource you created. In the Resource Management section, select **Keys and Endpoints**. Use the Endpoint URL for AZURE_OPENAI_ENDPOINT and the key 1 value for AZURE_OPENAI_API_KEY.

	{: .note }
	> To locate the values for AZURE_AI_SEARCH_ENDPOINT, AZURE_AI_SEARCH_INDEX, and AZURE_AI_SEARCH_API_KEY, in the Azure portal, select the Search Service instance you created.  On the Overview page, use the URL for AZURE_AI_SEARCH_ENDPOINT. In the left hand navigaation pane, in the Search Management section, select **Indexes**. Use the index name for AZURE_AI_SEARCH_INDEX. In the left hand navigation pane, in the Settings section, select **Keys**. Use Primary admin key for AZURE_AI_SEARCH_API_KEY.

 	{: .note }
	> For all parameters that start with "PG", use the values from the PostgreSQL connection string that you recorded earlier in the lab.

1. **Save** your changes and close the .env file.


1. Open a new Terminal prompt by selecting **Terminal** from the top menu and then **New Terminal**. Enter the following commands to create environment variables. 

    ```
    get-content .env | foreach {
    $name, $value = $_.split('=')
    set-content env:\$name $value
    }
    ```
1. Enter the following commands in the Terminal to create a connection to Azure Open AI.

    ```
    # open ai connection
    pf connection create --file azure_openai.yaml --name azure_openai --set "api_base=$env:AZURE_OPENAI_ENDPOINT" --set "api_key=$env:AZURE_OPENAI_API_KEY"
    # ai search connection
    pf connection create --file azure_ai_search.yaml --name azure_ai_search --set "api_base=$env:AZURE_AI_SEARCH_ENDPOINT" --set "api_key=$env:AZURE_AI_SEARCH_API_KEY"
    # postgresql connection
    pf connection create --file postgresql.yaml --name postgresql --set "configs.hostname=$env:PGHOST" --set "configs.port=$env:PGPORT" --set "configs.user=$env:PGUSER" --set "configs.database=$env:PGDATABASE" --set "secrets.passwd=$env:PGPASSWORD"
    ```
1. Enter the following command at the Terminal window prompt. This command lists all connections.

    ```
    pf connection list | ConvertFrom-Json | Select-Object name, type |Format-Table
    ```

    ![z9hosrka.png](../../media/z9hosrka.png)

1. Enter the following command at the Terminal window prompt. This command installs all dependencies listed in the requirements.txt file.

        pip install -r requirements.txt

1. Enter the following commands at the Terminal window prompt. These commands run the flow interactively so that you can peform testing. 

    ```
    pf flow test --flow . --interactive
    ```

    {: .note }
	> Try **Where can I ski?** and then **How many free rooms do hotels in Switzerland have grouped by hotel on 2024-10-10?**

    ![rlb45r1n.jpg](../../media/rlb45r1n.jpg)

    ![r55vg1go.jpg](../../media/r55vg1go.jpg)

    {: .warning }
	> Error: "pf.flow.test failed with UserErrorException: TypeError: Execution failure in 'chat_with_data'"

    ![gw7v3rcw.jpg](../../media/gw7v3rcw.jpg)

    1. The installed '**openai**' Python package may be incompatible with the script and throw the above error. Downgrading to 1.44.1 should resolve the issue.
    1. In the terminal you can check its version using **pip show openai**
    1. Downgrade the package by using **pip install openai==1.44.1**
    1. Run the interactive flow again:

        ```
        pf flow test --flow . --interactive
        ```

</details>

---
# Task 02 - Deploy the flow to Azure Container apps and test the app

<!--- Estimated time: 15 minutes---> 

## Introduction



## Description

In this task you will prepare the flow for deployment and deploy the flow. You will update the app to display the chatbot page.

The key steps are as follows:

1. Containerize the flow and push the flow to ACR.
1. Deploy the Container app and configure environmental variables.
1. Update the Contoso Hotel app to display the chatbot page


## Success Criteria

- You have updated the app to include the chatbot feature.

## Learning Resources

- [**Deploy a flow using Docker**](https://microsoft.github.io/promptflow/how-to-guides/deploy-a-flow/deploy-using-docker.html)
- [**Promptflow Reference**](https://microsoft.github.io/promptflow/reference/pf-command-reference.html#pf-flow)

## Solution

<details markdown="block">
<summary>Expand this section to view the solution</summary>


1. Change the value of **$ACR_NAME** to the Container Registry created in the earlier Exercise.

    ```
    $ACR_NAME="contosoacr745457"
    ```

    {: .note }
	> If you no longer have it noted down, you can find it again from the ContosoHotel Resource Group.

    ![ydqt4iqz.jpg](../../media/ydqt4iqz.jpg)

1. Enter the following command at the Terminal Window prompt and sign in.

    ```
    az login
    ```

1. Enter the following commands in the Visual Studio Code Terminal window prompt. These commands containerize the flow and push the flow to ACR.

    ```
    # login to acr
    az acr login --name "$ACR_NAME"
    # create flow
    pf flow build --source . --output docker-dist --format docker
    # copy the azure_openai.yaml, azure_ai_search.yaml, and postgresql.yaml into the connections folder
    Copy-Item -Path .\azure_openai.yaml -Destination .\docker-dist\connections -Force
    Copy-Item -Path .\azure_ai_search.yaml -Destination .\docker-dist\connections -Force
    Copy-Item -Path .\postgresql.yaml -Destination .\docker-dist\connections -Force
    # build container
    docker build -t "$ACR_NAME.azurecr.io/chatbot:v1.0.0" ./docker-dist
    # push it to acr
    docker push "$ACR_NAME.azurecr.io/chatbot:v1.0.0"
    # have an overview of defined environment variables
    Get-ChildItem -Path '.\docker-dist\connections' -Filter '*.yaml' | Get-Content | Select-String 'env:'
    # clean up
    Remove-Item -Recurse -Force ./docker-dist
    ```
    {: .note } 
	> Promptflow creates the connection yaml files in the connections folder based on the pf connection command. Ensure, that just 3 connections are defined and the names are azure_openai, azure_ai_search, and postgresql.

    ![t6qhp8kq.jpg](../../media/t6qhp8kq.jpg)

1. Configure and update the below variables based on your previous configurations and press **Enter**. **$CONTOSO_HOTEL_ENV** will be name of your **Container Apps Environment** found in the **ContosoHotel** Resource Group. The **_API_KEY**, **_ENDPOINT**, and **PGHOST** variable values can be found in the **.env file** from the last Task.

    ```
    $CONTOSO_HOTEL_ENV = "contosoenv890581"
    
    $AZURE_OPENAI_ENDPOINT = "https://azureopenai92140278.openai.azure.com/"
    $AZURE_OPENAI_API_KEY = "d3d089a5cb8d4dc0b7d1adc80e549da7"

    $AZURE_AI_SEARCH_ENDPOINT = "https://contososrch496682.search.windows.net"
    $AZURE_AI_SEARCH_API_KEY = "sUqFKOnX57fUKS0NBeKscezjp5d6ZCY7WVR2AmYOtPAzSeCrtJ0q"

    $PGHOST = "znuzgx66szs5y.postgres.database.azure.com"
    ```

    ![h6d4vbo8.jpg](../../media/h6d4vbo8.jpg)

1. Enter the following to set the variables for values we've used previously.
    ```
    $RG_NAME = "ContosoHotel"
    $CONTOSO_ACR_CREDENTIAL = az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv

    $PGUSER = "promptflow"
    $PGPASSWORD = "1234ABCD!"
    $PGDATABASE = "pycontosohotel"
    $PGPORT = "5432"
    ```

1. Enter the following commands in the Terminal to deploy the container to ACR and set envrionment variables. 

    ```
    az containerapp create --name "chatbot" --resource-group "$RG_NAME" --environment "$CONTOSO_HOTEL_ENV" `
    --image "$ACR_NAME.azurecr.io/chatbot:v1.0.0" --target-port 8080 --ingress internal --transport http `
    --registry-server "$ACR_NAME.azurecr.io" --registry-username "$ACR_NAME" --registry-password "$CONTOSO_ACR_CREDENTIAL" `
    --secrets "searchkey=$AZURE_AI_SEARCH_API_KEY" "openaikey=$AZURE_OPENAI_API_KEY" "pgpassword=$PGPASSWORD" `
    --env-vars "AZURE_AI_SEARCH_ENDPOINT=$AZURE_AI_SEARCH_ENDPOINT" "AZURE_AI_SEARCH_API_KEY=secretref:searchkey" `
    "AZURE_OPENAI_ENDPOINT=$AZURE_OPENAI_ENDPOINT" "AZURE_OPENAI_API_KEY=secretref:openaikey" `
    "PGHOST=$PGHOST" "PGPORT=$PGPORT" "PGUSER=$PGUSER" "PGDATABASE=$PGDATABASE" "PGPASSWORD=secretref:pgpassword"
    $CONTOSO_CHATBOT_URL = "https://$(az containerapp show --name "chatbot" --resource-group "$RG_NAME" --query 'properties.configuration.ingress.fqdn' -o tsv)"
    Write-Host -ForegroundColor Green  "Promptflow URL is: $CONTOSO_CHATBOT_URL"
    ```

    ![6g3gphnj.jpg](../../media/6g3gphnj.jpg)

1. Enter the following to pull and set the **$CONTOSO_BACKEND_URL** variable for use in the next step.

    ```
    $CONTOSO_BACKEND_URL = "https://$(az containerapp show --name "backend" --resource-group "ContosoHotel" --query 'properties.configuration.ingress.fqdn' -o tsv)"
    ```

1. Enter the following commands in the Visual Studio Code Terminal window prompt. These commands update the application front-end.

    ```
    az containerapp update --name "frontend" --resource-group "$RG_NAME" --set-env-vars "CHATBOT_BASEURL=$CONTOSO_BACKEND_URL"
    az containerapp update --name "backend" --resource-group "$RG_NAME" --set-env-vars "CHATBOT_BASEURL=$CONTOSO_CHATBOT_URL"
    ```

1. If you were able to deploy and update the values successfully, this Exercise is now complete. The deployment restricts access of the Container App to only internal Azure resources, so you will not be able to test this through your browser. The below screenshots display what the deployment *would* look like.

    ![09glo9jb.jpg](../../media/09glo9jb.jpg)

    ![pzm2vrpn.jpg](../../media/pzm2vrpn.jpg)

</details>
